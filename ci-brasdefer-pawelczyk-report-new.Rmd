---
title: "Causal Inference Report: Review on Child Penalty Bla"
author: 
  - Juan Pablo Brasdefer 
  - Fabian Pawelczyk
date: "`r Sys.Date()`" 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# load packages
library(dagitty)
library(ggdag)
library(ggplot2)
library(cowplot)
library(knitr)
```

# Research project
According to the DAG shown in Figure \@ref(fig:dag_plot), there is a causal relationship between the variable "birth_having_child" and "earnings."
\@ref(tab:dag_plot)


This paper meticulously examines the influence of having children on the gross labor earnings of both mothers and fathers (the estimand). Specifically, it delves into the _child penalty_ - a phenomenon referring to the potential decrease in earnings experienced by individuals, particularly women, upon becoming parents. This 'penalty' essentially represents the earnings disparity between those with children and those without.

The authors aim to contribute to the extensive literature on gender inequality by applying an event study methodology, with the birth of the first child serving as the central event. Utilizing a rich panel dataset that provides information on labor market outcomes and children, the authors navigate through the complex dynamics of parenthood and earnings, aiming to shed light on how gender inequality in earnings might be perpetuated by the advent of parenthood.

# DAG and extension

We present the baseline DAG in Figure X where the estimand is shown in the most simplest way.
However, the authors admit that earning penalties can come from three margins, nameley: the extensive margin of labor supply (employment), the intensive margin of labor supply (hours worked) and finally the wage rate (denoted by _w_). We include this into a new DAG (Figure X) to make clear that that the earnings consist of different parts.
\@ref(fig:dag_plot)

```{r dag_plot}
# The estimand as a DAG
estimand_dag <- dagify(earnings ~ birth_having_child,
                        outcome = "earnings",
                        exposure = "birth_having_child",
                        coords = list(x = c(birth_having_child = 1, earnings = 2),
                                      y = c(birth_having_child = 1, earnings = 1)))

ggdag_status(estimand_dag) +
  theme_dag() +
  guides(color = "none")  # Turn off legend
```

```{r}
# Define the DAG
# Defining abbreviations for our variables
# FC: First Child (exposure variable, representing the birth of the first child)
# E: Earnings (outcome variable, representing labor market outcomes)
# Emp: Employment (mediator variable, representing employment status)
# HW: Hours Worked (mediator variable, representing hours worked)
# W: Wage (mediator variable, representing wage)

dag <- dagitty( 'dag {
  "FC" [exposure,pos="0,0"]
  "E" [outcome,pos="2,0"]
  "Emp" [mediator,pos="1,1"]
  "HW" [mediator,pos="1,0"]
  "W" [mediator,pos="1,-1"]
  "FC" -> "Emp" 
  "FC" -> "HW"
  "FC" -> "W"
  "Emp" -> "E"
  "HW" -> "E"
  "W" -> "E"
}' )

# Print the DAG
ggdag_status(dag) +
  theme_dag() +
  guides(color = "none")  # Suppress the legend


```
```{r}
# Define the DAG
# FC: First Child (exposure variable, representing the birth of the first child)
# E: Earnings (outcome variable, representing labor market outcomes)
# LS: Labor Supply (mediator variable, representing the combined effect of employment status, hours worked, and wage)
# LCT: Life-Cycle Trends (confounder, representing trends across an individual's life cycle)
# TT: Time Trends (confounder, representing broader time-based trends)

dag <- dagitty( 'dag {
  "FC" [exposure,pos="1,1"]
  "E" [outcome,pos="3,1"]
  "LS" [mediator,pos="2,1"]
  "LCT" [pos="2,3"]
  "TT" [pos="2,0"]
  "LCT" -> "FC" 
  "LCT" -> "LS"
  "LCT" -> "E"
  "TT" -> "FC"
  "TT" -> "LS"
  "TT" -> "E"
  "FC" -> "LS"
  "LS" -> "E"
}' )

# Print the DAG
ggdag_status(dag) +
  theme_dag() +
  guides(color = "none")  # Suppress the legend


```


```{r}
# Define the DAG
# Defining abbreviations for our variables
# FC: First Child (exposure variable, representing the birth of the first child)
# E: Earnings (outcome variable, representing labor market outcomes)
# Emp: Employment (mediator variable, representing employment status)
# HW: Hours Worked (mediator variable, representing hours worked)
# W: Wage (mediator variable, representing wage)

dag <- dagitty( 'dag {
  "FC" [exposure,pos="0,0"]
  "E" [outcome,pos="2,0"]
  "Emp" [mediator,pos="1,1"]
  "HW" [mediator,pos="1,0"]
  "W" [mediator,pos="1,-1"]
  "FC" -> "Emp" 
  "FC" -> "HW"
  "FC" -> "W"
  "Emp" -> "E"
  "HW" -> "E"
  "W" -> "E"
}' )

# Print the DAG
ggdag_status(dag) +
  theme_dag() +
  guides(color = "none")  # Suppress the legend


```



```{r dag5, fig.cap= "This is DAG 5", out.width= "100%", fig.align='center'}
# Define the DAG
# FC: First Child (exposure variable, representing the birth of the first child)
# E: Earnings (outcome variable, representing labor market outcomes)
# LS: Labor Supply (mediator variable, representing the combined effect of employment status, hours worked, and wage)
# LCT: Life-Cycle Trends (confounder, representing trends across an individual's life cycle)
# TT: Time Trends (confounder, representing broader time-based trends)

dag <- dagitty( 'dag {
  "FC" [exposure,pos="1,1"]
  "E" [outcome,pos="3,1"]
  "LS" [mediator,pos="2,1"]
  "LCT" [pos="2,3"]
  "TT" [pos="2,0"]
  "FC" -> "LS"
  "LS" -> "E"

}' )

# Print the DAG
ggdag_status(dag) +
  theme_dag() +
  guides(color = "none")  # Suppress the legend

```

<!--The main outcome variable considered in this study is gross labor earnings. The authors convert the estimated effects into percentages to measure the child penalty experienced by women compared to men due to children.

Overall, the paper focuses on estimating the impact of having children on labor market outcomes for mothers and fathers, utilizing event studies and regression models. The goal is to identify and quantify the child penalties experienced by women relative to men in terms of earnings and labor market trajectories.

We will use the term _child penalty_ throughout the report which is a common term in the literature and points towards the lower projected earnings of mothers compared to fathers. However, while this term suggests that women do not voluntarily choose positions that have valuable family amentiies (but lower wages) we do not want to suggest that this causal explaination is final as we discuss in the last section.-->

# Walk through the causal inference pipeline

# First, what is the estimand? 
<!--Have a clear idea of what it is that we want to measure.-->
The estimand: Impact of children on the earnings of women relative to men.
Then let's ref this shit `\ref(fig:dag5)`



```{r}



# Define the DAG
# Defining abbreviations for our variables
# FC: First Child (exposure variable, representing the birth of the first child)
# E: Earnings (outcome variable, representing labor market outcomes)
# Emp: Employment (mediator variable, representing employment status)
# HW: Hours Worked (mediator variable, representing hours worked)
# W: Wage (mediator variable, representing wage)
# EB: Employer Benefits

dag <- dagitty( 'dag {
  "FC" [exposure,pos="0,0"]
  "E" [outcome,pos="2,0"]
  "Emp" [mediator,pos="1,1"]
  "HW" [mediator,pos="1,0"]
  "W" [mediator,pos="1,-1"]
  "EB" [mediator, pos="1,-2"]
  "FC" -> "Emp" 
  "FC" -> "HW"
  "FC" -> "W"
  "FC" -> "EB"
  "Emp" -> "E"
  "HW" -> "E"
  "W" -> "E"
  "EB" -> "E"
}' )

# Print the DAG
ggdag_status(dag) +
  theme_dag() +
  guides(color = "none")  # Suppress the legend

```
$$Y^{g}_{\text{ist}} = \sum_{j \neq -1} \alpha^{g}_{j} \cdot I[j = t] + \sum_k \beta^{g}_{k} \cdot I[k = \text{age}_{is}] + \sum_y \gamma^{g}_{y} \cdot I[y = s] + \nu^{g}_{\text{ist}}
$$



### Second, thinking about the data
<!--How will I gather data?
Will the data be generated via an experimental design, was there an experiment already done, maybe a natural experiment, or would the only available data be purely observational? -->
What kind of data do we have? How was the data gathered?

### Three, contemplaiting the data generation process
Draw out the DAG that you consider best explains the data generation process. 

### Fourth, Identification strategy!
Confounders? Colliders? Mediators? What are we controlling for or not controlling for? 


# Advanced identification strategy: DID and IV variables
<!--Fixed effects? Matching? Propecity scores? Diff-in-Diff? Wait it was already randomized we're all good? 
ATE? CATE? ITE?-->
## Instrumental Variable Event Study
To validate whether the authors identification strategy is valid the authors run two main identification checks in order to test the robustness of the results and therefore to address potential bias and establish a causal inference.

In this identification check, the authors propose a variation of their event study approach by introducing an Instrumental Variable (IV) strategy. They use the gender composition of the first two children as an instrument for having a third child, following the reasoning that parents with two same-sex children are more likely to have a third child. The validity of this instrument relies on the assumption that the sex of the first two children doesn't independently impact labor market outcomes (the exclusion restriction).

The authors modify their event study specification to estimate the Local Average Treatment Effect (LATE) of having a third child. This means they are focusing on the subpopulation influenced by the instrument (the "compliers"). The model is defined as:

To facilitate a valid comparison, the authors modify their event study model as follows:

$$Y^{}_{\text{istt'}} = \sum_{j \neq -1} \alpha^{}_{j} \cdot I[j = t] + \sum_k \beta^{}_{k} \cdot I[k = \text{age}_{is}] + \sum_y \gamma^{}_{y} \cdot I[y = s] + \sum_{n \neq -1} \delta^{}_{n} \cdot I[j = t'] + \nu^{}_{\text{istt'}}
$$

In this model, t' represents the event time with respect to the third child. The new term $∑ δ_n · I[n = t']$ introduces event time dummies for the birth of the third child. The authors also keep the event time dummies for the first child, as previous childbearing dynamics may impact the effect of the third child.

The IV specification is identical, except it includes an additional instrumenting strategy which instruments the event time dummies around the third child birth using the sex mix of the first two children:

$$I[n = t'] = I[n = t'] * I[same sex siblings]$$

In other words, I[n = t'] takes the value of one when the woman is at event time t' (previous t0) with respect to the third child and her first two children are of the same sex.

The counterfactual outcome, denoted $\tilde{Y}^w_{istt'}$, is calculated excluding the effect of the third child but including the effects of the first child and other controls. It represents the expected labour market outcome for a woman if she did not have a third child, providing a baseline against which to compare the actual outcomes of those who did have a third child.

The findings suggest that the event study and IV estimates align closely, indicating robustness in their empirical approach. The short-run effect of the third child is similar to that of the first, showing an earnings reduction of 20-30%. However, the long-run effect of a third child is about 5%, lower than the long-run effect of the first child for those who only have one child, suggesting a diminishing marginal effect with the addition of more children.

```{r}
# Define the DAG
# Define a simple DAG
dag_text <- '
dag {
FirstChild -> LaborMarketOutcome
SecondChild -> LaborMarketOutcome
ThirdChild -> LaborMarketOutcome
SexComposition -> ThirdChild
TimeTrends -> LaborMarketOutcome
LifeCycleTrends -> LaborMarketOutcome
}'

# Parse the DAG
#dag2 <- dagitty(dag_text)

# Plot the DAG
#plot(dag2)
# Print the DAG
#ggdag_status(dag2) +
 # theme_dag() +
 # guides(color = "none")

```

```{r}



# Define the DAG with abbreviations
third_child_dag <- dagify(E ~ T1 + T2 + T3 + TT + LC,
                          T3 ~ SC + T1 + T2,
                          T2 ~ T1,
                          T1 ~ TT + LC,
                          labels = c("E" = "LaborMarketOutcome",
                                     "T1" = "FirstChild",
                                     "T2" = "SecondChild",
                                     "T3" = "ThirdChild",
                                     "TT" = "TimeTrends",
                                     "LC" = "LifeCycleTrends",
                                     "SC" = "SexComposition"),
                          exposure = "T3",
                          outcome = "E",
                          coords = list(x = c(T1 = 2, T2 = 3, T3 = 4, SC = 3, TT = 1, LC = 1, E = 5),
                                        y = c(T1 = 2, T2 = 2, T3 = 2, SC = 3, TT = 3, LC = 1, E = 2)))

# Draw the DAG
dag_plot <- ggdag_status(third_child_dag) +
  theme_dag() +
  guides(color = "none")  # Turn off legend

# Add a title and caption
dag_plot +
  ggtitle("Directed Acyclic Graph (DAG) for the Third Child Study") +
  labs(caption = "Note: E - LaborMarketOutcome, T1 - FirstChild, T2 - SecondChild, T3 - ThirdChild, SC - SexComposition, TT - TimeTrends, LC - LifeCycleTrends")



```




# Evaluate
## How can we improve the research? 
## Does it make sense how they did it?


### Where to put the section on method? 
Regression, event study
"To investigate this question, we adopt an event study approach based on sharp changes around the birth of the first child for mothers relative to fathers. *Although fertility choices are not exogenous*, the event of having a first child generates sharp changes in labor market outcomes that are arguably orthogonal to unobserved determinants of those outcomes as they should evolve smoothly over time."

From Appendix 2019 paper we get: "The latter effect captures for example that some women may take less education or
opt for family-friendly career tracks knowing that they will eventually have many children.
While we do not specify the demand for children, we make the assumption that children kit are
exogenous to the outcome variable Yit conditional on the set of underlying determinants zit." -> maybe this is what we can make some suggestions about?


## Ok let's give it a go

**Step 1**

Estimand. The effect of `treatment` on `outcome`. 

**Step 2**
Data. Our avbailable variables are `gre`,`gpa`, `camp`, and `grade`. 

**Step 3: DAG**

We'll think about a DAG with just four nodes. 

```{r}
language_camp_dag <- dagify(grade ~ camp + gpa + gre,
                        camp ~ gpa + gre,
                        gre ~ gpa,
                        outcome = "grade",
                        exposure = "camp",
                        coords = list(x = c(camp = 1, gpa = 2, gre = 3, grade = 4),
                                      y = c(camp = 1, gpa = 2, gre = 2, grade = 1)))

ggdag_status(language_camp_dag) +
  theme_dag() +
  guides(color = "none")  # Turn off legend
```

**Part 4**

Students' GRE scores and undergraduate GPAs confound both the choice to enroll in the camp and final class grades. Additionally, undergraduate degrees help cause GRE scores.

*We will generate syntetic data for this example*

```{r}

library(scales)

# 1. GPA is associated with GRE scores
# 2. Camp (binary) is associated with undergraduate GPA and GRE scores. Calculate a camp score and then a camp binary variable from it. 
# 3. Final grade is caused by language camp, undergraduate GPA, and GRE scores

gpa <- rnorm(100, mean = 2.5,sd = 1.5)
e_gre <- rnorm(100, mean = 5, sd = 5)
gre <- 140 + gpa*10 + e_gre
gre_r<-rescale(gre, to = c(100, 170))

e_camp_score <- rnorm(100, mean= 50, sd= 20)
camp_score <- e_camp_score + 5*gpa + gre_r/5
camp_score_r <- rescale(camp_score, to = c(0, 100))

```

**More part 4: Specify how these nodes are measured**

See if you can find the effect. Run two models:

- `grade ~ camp`: This is the naive, unadjusted, correlation-is-not-causation estimate. It's wrong.

- `grade ~ camp + gpa + gre`: This is the adjusted estimate. 

(Also adjust for GPA and GRE with inverse probability weighting to see if the ATE for `camp` still holds. This is entirely optional.)

```{r}
# Specify the models 

# lm( ~ )

```

ATE = 

**Part 5**

Evaluation
